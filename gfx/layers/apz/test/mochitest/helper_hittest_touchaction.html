<!DOCTYPE HTML>
<html>
<head>
  <title>Testing APZ hit-test with touch-action boxes</title>
  <script type="application/javascript" src="apz_test_utils.js"></script>
  <script type="application/javascript" src="apz_test_native_event_utils.js"></script>
  <script type="application/javascript" src="/tests/SimpleTest/paint_listener.js"></script>
  <meta name="viewport" content="width=device-width"/>
  <style>
.taBox {
    width: 20px;
    height: 20px;
    background-color: green;
    display: inline-block;
}
.taBox div {
    /* make sure this doesn't obscure the center of the enclosing taBox */
    width: 5px;
    height: 5px;
    background-color: blue;
}
  </style>
</head>
<body>
<!-- Create a bunch of divs for hit-testing. Some of the divs also
    contain nested divs to test inheritance/combination of touch-action
    properties. This is not an exhaustive list of all the possible
    combinations but it's assorted enough to provide good coverage. -->
 <div id="taNone" class="taBox" style="touch-action: none">
    <div id="taInnerNonePanX" style="touch-action: pan-x"></div>
    <div id="taInnerNoneManip" style="touch-action: manipulation"></div>
 </div>
 <div id="taPanX" class="taBox" style="touch-action: pan-x">
    <div id="taInnerPanXY" style="touch-action: pan-y"></div>
    <div id="taInnerPanXManip" style="touch-action: manipulation"></div>
 </div>
 <div id="taPanY" class="taBox" style="touch-action: pan-y">
    <div id="taInnerPanYX" style="touch-action: pan-x"></div>
    <div id="taInnerPanYY" style="touch-action: pan-y"></div>
 </div>
 <div id="taPanXY" class="taBox" style="touch-action: pan-x pan-y">
    <div id="taInnerPanXYNone" style="touch-action: none"></div>
 </div>
 <div id="taManip" class="taBox" style="touch-action: manipulation">
    <div id="taInnerManipPanX" style="touch-action: pan-x"></div>
    <div id="taInnerManipNone" style="touch-action: none"></div>
    <div id="taInnerManipListener" ontouchstart="return false;"></div>
 </div>
 <div id="taListener" class="taBox" ontouchstart="return false;">
    <div id="taInnerListenerPanX" style="touch-action: pan-x"></div>
 </div>
</body>
<script type="application/javascript">

var config = getHitTestConfig();

function test() {
  var scrollId = config.utils.getViewId(document.scrollingElement);

  checkHitResult(
      hitTest(centerOf('taNone')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: none");
  checkHitResult(
      hitTest(centerOf('taInnerNonePanX')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-x inside touch-action: none");
  checkHitResult(
      hitTest(centerOf('taInnerNoneManip')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: manipulation inside touch-action: none");

  checkHitResult(
      hitTest(centerOf('taPanX')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-x");
  checkHitResult(
      hitTest(centerOf('taInnerPanXY')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-y inside touch-action: pan-x");
  checkHitResult(
      hitTest(centerOf('taInnerPanXManip')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: manipulation inside touch-action: pan-x");

  checkHitResult(
      hitTest(centerOf('taPanY')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-y");
  checkHitResult(
      hitTest(centerOf('taInnerPanYX')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-x inside touch-action: pan-y");
  checkHitResult(
      hitTest(centerOf('taInnerPanYY')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-y inside touch-action: pan-y");

  checkHitResult(
      hitTest(centerOf('taPanXY')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-x pan-y");
  checkHitResult(
      hitTest(centerOf('taInnerPanXYNone')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: none inside touch-action: pan-x pan-y");

  checkHitResult(
      hitTest(centerOf('taManip')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: manipulation");
  checkHitResult(
      hitTest(centerOf('taInnerManipPanX')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-x inside touch-action: manipulation");
  checkHitResult(
      hitTest(centerOf('taInnerManipNone')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.PAN_X_DISABLED |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: none inside touch-action: manipulation");
  checkHitResult(
      hitTest(centerOf('taInnerManipListener')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.DISPATCH_TO_CONTENT |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "div with touch listener inside touch-action: manipulation");

  checkHitResult(
      hitTest(centerOf('taListener')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.DISPATCH_TO_CONTENT,
      scrollId,
      "div with touch listener");
  checkHitResult(
      hitTest(centerOf('taInnerListenerPanX')),
      APZHitResultFlags.VISIBLE |
      APZHitResultFlags.DISPATCH_TO_CONTENT |
      APZHitResultFlags.PAN_Y_DISABLED |
      APZHitResultFlags.PINCH_ZOOM_DISABLED |
      APZHitResultFlags.DOUBLE_TAP_ZOOM_DISABLED,
      scrollId,
      "touch-action: pan-x inside div with touch listener");
}

if (!config.isWebRender) {
  ok(true, "This test is WebRender-only because we get a bunch of dispatch-to-content regions without it and the test isn't very interesting.");
  subtestDone();
} else {
  waitUntilApzStable()
    .then(test)
    .then(subtestDone);
}

</script>
</html>
